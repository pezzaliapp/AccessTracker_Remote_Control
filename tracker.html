<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Access Tracker</title>
  <link rel="manifest" href="manifest.json" />
  <style>body{font-family:sans-serif;text-align:center;padding:40px}</style>
</head>
<body>
  <h1>Access Tracker</h1>
  <p id="msg">Attesa login‚Ä¶</p>

  <!-- form di login -->
  <form id="loginForm" style="margin:20px auto;max-width:300px">
    <input  type="email"    id="email"    placeholder="e-mail" value="tuo@email.it" required><br>
    <input  type="password" id="password" placeholder="password"           required><br>
    <button type="submit">Accedi</button>
  </form>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    /* Config Firebase */
    const firebaseConfig = {
      apiKey:"AIzaSyCm9lIf2l8FQHiIUoSbtOmLRQNxtgCJd6Q",
      authDomain:"accesstracker-5d3f9.firebaseapp.com",
      projectId:"accesstracker-5d3f9"
    };
    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const db   = firebase.firestore();
    const msg  = document.getElementById('msg');
    const form = document.getElementById('loginForm');

    /* login manuale */
    form.addEventListener('submit', e=>{
      e.preventDefault();
      auth.signInWithEmailAndPassword(form.email.value.trim(), form.password.value)
          .catch(err=>alert('Login fallito: '+err.message));
    });

    /* quando loggato, avvia tracker */
    auth.onAuthStateChanged(user=>{
      if(!user){msg.textContent='Attesa login‚Ä¶';return;}
      form.style.display='none';
      msg.textContent='üîÑ Controllo in corso‚Ä¶';

      db.collection('controllo').doc('stato').get().then(doc=>{
        if(doc.exists && doc.data().attivo){
          db.collection('accessi').add({
            timestamp: new Date().toISOString(),
            userAgent: navigator.userAgent
          }).then(()=>msg.textContent='‚úÖ Accesso registrato.')
            .catch(e=>msg.textContent='‚ùå Errore scrittura: '+e.message);
        }else{
          msg.textContent='‚õî Tracker disattivato da remoto.';
        }
      });
    });
  </script>
</body>
</html>
